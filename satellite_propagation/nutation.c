//
// Created by Леша on 24.05.15.
//

#include "nutation.h"
#include "constants.h"
#include "rotation_matrix.h"
#include "matrix_operations.h"


long double get_eps_mean(long double tdb)
{
    long double ts = (tdb - 51544.5) / 36525;
    long double ts2 = ts*ts;
    long double ts3 = ts*ts2;
    return SEC_IN_RAD*(84381.448 - 46.8150*ts - 0.00059*ts2 + 0.001813*ts3);
}


void get_fundumental_args(long double tdb, long double fund_args[5])
{
    int i;
    long double r, l;
    long double dt = (tdb - 51544.5) / 36525.0;
    long double dt2 = dt*dt;
    long double dt3 = dt*dt2;

    fund_args[0] = 218.31643250L + 481267.8812772222L*dt
                -0.00161167L*dt2 + 0.00000528L*dt3;
    fund_args[1] = 134.96298139L + 477198.8673980556L*dt
                +0.00869722L*dt2 + 0.00001778L*dt3;
    fund_args[2] = 357.52772333L + 35999.05034L*dt
                -0.00016028e0L*dt2 - 0.00000333L*dt3;
    fund_args[3] = 93.27191028L + 483202.0175380555L*dt
                 -0.00368250L*dt2 + 0.00000306L*dt3;
    fund_args[4] = 297.85036306L + 445267.11148L*dt
                -0.00191417L*dt2 + 0.00000528L*dt3;

    for (i = 0; i < 5; i++)
    {
        r = fund_args[i];
        l = truncl(r / 360.0);
        fund_args[i] = (GRAD_IN_RAD) * (r - 360.0*l);
    }

    return;
}


void get_corr_fundumental_args(long double tdb, long double corr_fund_args[5])
{
    long double s[7];
    long double ts, dr;

    get_fundumental_args(tdb, corr_fund_args);
    
    ts = (tdb - 51544.5L) / 36525.0L;
    s[0] = sinl(1.24614L + 0.35255L*ts);
    s[1] = sinl(1.75106L + 0.28325L*ts);
    s[2] = sinl(1.05727L - 2.31868L*ts);
    s[3] = sinl(2.18240L - 33.7571L*ts);
    s[4] = sinl(0.65961L - 33.79719L*ts);
    s[5] = sinl(2.68173L - 2.62983L*ts);
    s[6] = sinl(0.93890L - 33.77281L*ts);

    dr = 0.31L*s[1] + 14.27L*s[2];
    corr_fund_args[0] += SEC_IN_RAD*(0.84L*s[0] + dr + 7.26L*s[3] + 0.28L*s[4] + 0.24L*s[5]); // { lambda rd }
    corr_fund_args[1] += SEC_IN_RAD*(2.94L*s[0] + dr + 9.34L*s[3]+1.12L*s[4] + 0.83L*s[5]);   // { l  radian }
    corr_fund_args[2] -= SEC_IN_RAD*(6.4L*s[0] + 1.89L*s[5]);                                 // { l' radian }
    corr_fund_args[3] += SEC_IN_RAD*(0.21L*s[0]+dr-88.7L*s[3]-15.3L*s[4] + 0.24L*s[5] - 1.86L*s[6]); // { F }
    corr_fund_args[4] +=SEC_IN_RAD*(7.24L*s[0]+dr + 7.26L*s[3] + 0.28L*s[4]+2.13L*s[5]);      // { D  radian }
}


void get_nutation_parameters(long double tdb, long double *psi, long double *eps)
{
    // 1980 IAU Theory of Nutation  ( J. M. Wahr )
    short nut_args[106][5] =
          { {   1 ,    0 ,    0 ,    0 ,    0 } ,
            {   2 ,    0 ,    0 ,    0 ,    0 } ,
            {   1 ,   -2 ,    0 ,    2 ,    0 } ,
            {   0 ,    2 ,    0 ,   -2 ,    0 } ,
            {   2 ,   -2 ,    0 ,    2 ,    0 } ,
            {   0 ,    1 ,   -1 ,    0 ,   -1 } ,
            {   1 ,    0 ,   -2 ,    2 ,   -2 } ,
            {   1 ,    2 ,    0 ,   -2 ,    0 } ,
            {   2 ,    0 ,    0 ,    2 ,   -2 } ,
            {   0 ,    0 ,    1 ,    0 ,    0 } ,
            {   2 ,    0 ,    1 ,    2 ,   -2 } ,
            {   2 ,    0 ,   -1 ,    2 ,   -2 } ,
            {   1 ,    0 ,    0 ,    2 ,   -2 } ,
            {   0 ,    2 ,    0 ,    0 ,   -2 } ,
            {   0 ,    0 ,    0 ,    2 ,   -2 } ,
            {   0 ,    0 ,    2 ,    0 ,    0 } ,
            {   1 ,    0 ,    1 ,    0 ,    0 } ,
            {   2 ,    0 ,    2 ,    2 ,   -2 } ,
            {   1 ,    0 ,   -1 ,    0 ,    0 } ,
            {   1 ,   -2 ,    0 ,    0 ,    2 } ,
            {   1 ,    0 ,   -1 ,    2 ,   -2 } ,
            {   1 ,    2 ,    0 ,    0 ,   -2 } ,
            {   1 ,    0 ,    1 ,    2 ,   -2 } ,
            {   0 ,    1 ,    0 ,    0 ,   -1 } ,
            {   0 ,    2 ,    1 ,    0 ,   -2 } ,
            {   1 ,    0 ,    0 ,   -2 ,    2 } ,
            {   0 ,    0 ,    1 ,   -2 ,    2 } ,
            {   2 ,    0 ,    1 ,    0 ,    0 } ,
            {   1 ,   -1 ,    0 ,    0 ,    1 } ,
            {   0 ,    0 ,    1 ,    2 ,   -2 } ,
            {   2 ,    0 ,    0 ,    2 ,    0 } ,
            {   0 ,    1 ,    0 ,    0 ,    0 } ,
            {   1 ,    0 ,    0 ,    2 ,    0 } ,
            {   2 ,    1 ,    0 ,    2 ,    0 } ,
            {   0 ,    1 ,    0 ,    0 ,   -2 } ,
            {   2 ,   -1 ,    0 ,    2 ,    0 } ,
            {   0 ,    0 ,    0 ,    0 ,    2 } ,
            {   1 ,    1 ,    0 ,    0 ,    0 } ,
            {   1 ,   -1 ,    0 ,    0 ,    0 } ,
            {   2 ,   -1 ,    0 ,    2 ,    2 } ,
            {   1 ,    1 ,    0 ,    2 ,    0 } ,
            {   2 ,    0 ,    0 ,    2 ,    2 } ,
            {   0 ,    2 ,    0 ,    0 ,    0 } ,
            {   2 ,    1 ,    0 ,    2 ,   -2 } ,
            {   2 ,    2 ,    0 ,    2 ,    0 } ,
            {   0 ,    0 ,    0 ,    2 ,    0 } ,
            {   1 ,   -1 ,    0 ,    2 ,    0 } ,
            {   1 ,   -1 ,    0 ,    0 ,    2 } ,
            {   1 ,    1 ,    0 ,    0 ,   -2 } ,
            {   1 ,   -1 ,    0 ,    2 ,    2 } ,
            {   0 ,    1 ,    1 ,    0 ,   -2 } ,
            {   2 ,    0 ,    1 ,    2 ,    0 } ,
            {   2 ,    0 ,   -1 ,    2 ,    0 } ,
            {   2 ,    1 ,    0 ,    2 ,    2 } ,
            {   0 ,    1 ,    0 ,    0 ,    2 } ,
            {   2 ,    2 ,    0 ,    2 ,   -2 } ,
            {   1 ,    0 ,    0 ,    0 ,    2 } ,
            {   1 ,    0 ,    0 ,    2 ,    2 } ,
            {   1 ,    1 ,    0 ,    2 ,   -2 } ,
            {   1 ,    0 ,    0 ,    0 ,   -2 } ,
            {   0 ,    1 ,   -1 ,    0 ,    0 } ,
            {   1 ,    2 ,    0 ,    2 ,    0 } ,
            {   0 ,    0 ,    1 ,    0 ,   -2 } ,
            {   0 ,    1 ,    0 ,   -2 ,    0 } ,
            {   0 ,    0 ,    0 ,    0 ,    1 } ,
            {   0 ,    1 ,    1 ,    0 ,    0 } ,
            {   0 ,    1 ,    0 ,    2 ,    0 } ,
            {   2 ,    1 ,   -1 ,    2 ,    0 } ,
            {   2 ,   -1 ,   -1 ,    2 ,    2 } ,
            {   1 ,   -2 ,    0 ,    0 ,    0 } ,
            {   2 ,    3 ,    0 ,    2 ,    0 } ,
            {   2 ,    0 ,   -1 ,    2 ,    2 } ,
            {   2 ,    1 ,    1 ,    2 ,    0 } ,
            {   1 ,   -1 ,    0 ,    2 ,   -2 } ,
            {   1 ,    2 ,    0 ,    0 ,    0 } ,
            {   2 ,    1 ,    0 ,    0 ,    0 } ,
            {   0 ,    3 ,    0 ,    0 ,    0 } ,
            {   2 ,    0 ,    0 ,    2 ,    1 } ,
            {   2 ,   -1 ,    0 ,    0 ,    0 } ,
            {   0 ,    1 ,    0 ,    0 ,   -4 } ,
            {   2 ,   -2 ,    0 ,    2 ,    2 } ,
            {   2 ,   -1 ,    0 ,    2 ,    4 } ,
            {   0 ,    2 ,    0 ,    0 ,   -4 } ,
            {   2 ,    1 ,    1 ,    2 ,   -2 } ,
            {   1 ,    1 ,    0 ,    2 ,    2 } ,
            {   2 ,   -2 ,    0 ,    2 ,    4 } ,
            {   2 ,   -1 ,    0 ,    4 ,    0 } ,
            {   0 ,    1 ,   -1 ,    0 ,   -2 } ,
            {   1 ,    2 ,    0 ,    2 ,   -2 } ,
            {   2 ,    2 ,    0 ,    2 ,    2 } ,
            {   1 ,    1 ,    0 ,    0 ,    2 } ,
            {   2 ,    0 ,    0 ,    4 ,   -2 } ,
            {   2 ,    3 ,    0 ,    2 ,   -2 } ,
            {   0 ,    1 ,    0 ,    2 ,   -2 } ,
            {   1 ,    0 ,    1 ,    2 ,    0 } ,
            {   1 ,   -1 ,   -1 ,    0 ,    2 } ,
            {   1 ,    0 ,    0 ,   -2 ,    0 } ,
            {   2 ,    0 ,    0 ,    2 ,   -1 } ,
            {   0 ,    0 ,    1 ,    0 ,    2 } ,
            {   0 ,    1 ,    0 ,   -2 ,   -2 } ,
            {   1 ,    0 ,   -1 ,    2 ,    0 } ,
            {   1 ,    1 ,    1 ,    0 ,   -2 } ,
            {   0 ,    1 ,    0 ,   -2 ,    2 } ,
            {   0 ,    2 ,    0 ,    0 ,    2 } ,
            {   2 ,    0 ,    0 ,    2 ,    4 } ,
            {   0 ,    0 ,    1 ,    0 ,    1 } } ;
    
    // 1980 IAU Theory of Nutation  ( J. M. Wahr )
    float nut_coeff[106][4] =
          { {   -17.199600 ,     -0.017420 ,      9.202500 ,      0.000890 } ,
            {     0.206200 ,      0.000020 ,     -0.089500 ,      0.000050 } ,
            {     0.004600 ,      0.000000 ,     -0.002400 ,      0.000000 } ,
            {     0.001100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000200 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -1.318700 ,     -0.000160 ,      0.573600 ,     -0.000310 } ,
            {     0.142600 ,     -0.000340 ,      0.005400 ,     -0.000010 } ,
            {    -0.051700 ,      0.000120 ,      0.022400 ,     -0.000060 } ,
            {     0.021700 ,     -0.000050 ,     -0.009500 ,      0.000030 } ,
            {     0.012900 ,      0.000010 ,     -0.007000 ,      0.000000 } ,
            {     0.004800 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.002200 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.001700 ,     -0.000010 ,      0.000000 ,      0.000000 } ,
            {    -0.001500 ,      0.000000 ,      0.000900 ,      0.000000 } ,
            {    -0.001600 ,      0.000010 ,      0.000700 ,      0.000000 } ,
            {    -0.001200 ,      0.000000 ,      0.000600 ,      0.000000 } ,
            {    -0.000600 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {    -0.000500 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {     0.000400 ,      0.000000 ,     -0.000200 ,      0.000000 } ,
            {     0.000400 ,      0.000000 ,     -0.000200 ,      0.000000 } ,
            {    -0.000400 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.227400 ,     -0.000020 ,      0.097700 ,     -0.000050 } ,
            {     0.071200 ,      0.000010 ,     -0.000700 ,      0.000000 } ,
            {    -0.038600 ,     -0.000040 ,      0.020000 ,      0.000000 } ,
            {    -0.030100 ,      0.000000 ,      0.012900 ,     -0.000010 } ,
            {    -0.015800 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {     0.012300 ,      0.000000 ,     -0.005300 ,      0.000000 } ,
            {     0.006300 ,      0.000000 ,     -0.000200 ,      0.000000 } ,
            {     0.006300 ,      0.000010 ,     -0.003300 ,      0.000000 } ,
            {    -0.005800 ,     -0.000010 ,      0.003200 ,      0.000000 } ,
            {    -0.005900 ,      0.000000 ,      0.002600 ,      0.000000 } ,
            {    -0.005100 ,      0.000000 ,      0.002700 ,      0.000000 } ,
            {    -0.003800 ,      0.000000 ,      0.001600 ,      0.000000 } ,
            {     0.002900 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {     0.002900 ,      0.000000 ,     -0.001200 ,      0.000000 } ,
            {    -0.003100 ,      0.000000 ,      0.001300 ,      0.000000 } ,
            {     0.002600 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {     0.002100 ,      0.000000 ,     -0.001000 ,      0.000000 } ,
            {     0.001600 ,      0.000000 ,     -0.000800 ,      0.000000 } ,
            {    -0.001300 ,      0.000000 ,      0.000700 ,      0.000000 } ,
            {    -0.001000 ,      0.000000 ,      0.000500 ,      0.000000 } ,
            {    -0.000700 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000700 ,      0.000000 ,     -0.000300 ,      0.000000 } ,
            {    -0.000700 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {    -0.000800 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {     0.000600 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000600 ,      0.000000 ,     -0.000300 ,      0.000000 } ,
            {    -0.000600 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {    -0.000700 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {     0.000600 ,      0.000000 ,     -0.000300 ,      0.000000 } ,
            {    -0.000500 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {     0.000500 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000500 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {    -0.000400 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000400 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000400 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000300 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000200 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {     0.000200 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000200 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {     0.000200 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000200 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {     0.000200 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000200 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000200 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } } ;

    long double ts = (tdb - 51544.5) / 36525.0;
    long double delta_psi = 0, delta_eps = 0;
    int i, j;

    long double fund_args[5];
    get_fundumental_args(tdb, fund_args);

    long double r = 0;
    for (i=0; i<106; i++)
    {
        r = nut_args[i][0] * (fund_args[0] - fund_args[3]);
        for (j=1; j<5; j++)
        {
            r += nut_args[i][j] * fund_args[j];
        }
        delta_psi += (nut_coeff[i][0] + ts*nut_coeff[i][1]) * sinl(r);
        delta_eps += (nut_coeff[i][2] + ts*nut_coeff[i][3]) * cosl(r);
    }
    *psi = delta_psi * SEC_IN_RAD;
    *eps = delta_eps * SEC_IN_RAD;

    return;
}


void get_nutation_matrix(long double tdb, long double nutation_matrix[3][3])
{
    long double Rx_deps[3][3], Rz_psi[3][3], Rx_eps[3][3], R[3][3];
    long double delta_psi, delta_eps;
    long double eps = get_eps_mean(tdb);

    get_nutation_parameters(tdb, &delta_psi, &delta_eps);

    rotate_by_x(-eps-delta_eps, Rx_deps);
    rotate_by_z(-delta_psi, Rz_psi);
    rotate_by_x(eps, Rx_eps);
    mult_matrix(Rz_psi, Rx_eps, R);
    mult_matrix(Rx_deps, R, nutation_matrix);

    return;
}