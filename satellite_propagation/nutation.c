//
// Created by Леша on 24.05.15.
//

#include "nutation.h"
#include "constants.h"
#include "rotation_matrix.h"
#include "matrix_operations.h"


double get_eps_mean(double tdb)
{
    double ts = (tdb - 51544.5) / 36525;
    double ts2 = ts*ts;
    double ts3 = ts*ts2;
    return SEC_IN_RAD*(84381.448-46.8150*ts-0.00059*ts2+0.001813*ts3);
}


void get_fundumental_args(double tdb, double fund_args[5])
{
    double ts = (tdb - 51544.5) / 36525;
    double ts2 = ts*ts;
    double ts3 = ts*ts2;

    fund_args[0] = 218.31643250 + 481267.8812772222*ts
                   - 0.00161167*ts2 + 0.00000528*ts3;
    fund_args[1] = 134.96298139 + 477198.8673980556*ts
                   + 0.00869722*ts2 + 0.00001778*ts3;
    fund_args[2] = 357.52772333 + 35999.05034*ts
                   - 0.00016028*ts2 - 0.00000333*ts;
    fund_args[3] = 93.27191028 + 483202.0175380555*ts
                   - 0.00368250*ts2 + 0.00000306*ts3;
    fund_args[4] = 297.85036306 + 445267.11148*ts
                   - 0.00191417*ts2 + 0.00000528*ts3;

    int i;
    double r, l;
    for (i=0; i<5; i++)
    {
        r = fund_args[i];
        l = trunc(r / 360);
        fund_args[i] = GRAD_IN_RAD * (r - 360*l);
    }

    return;
}


void get_nutation_parameters(double tdb, double *psi, double *eps)
{
    // 1980 IAU Theory of Nutation  ( J. M. Wahr )
    int nut_args[106][5] =
          { {   1 ,    0 ,    0 ,    0 ,    0 } ,
            {   2 ,    0 ,    0 ,    0 ,    0 } ,
            {   1 ,   -2 ,    0 ,    2 ,    0 } ,
            {   0 ,    2 ,    0 ,   -2 ,    0 } ,
            {   2 ,   -2 ,    0 ,    2 ,    0 } ,
            {   0 ,    1 ,   -1 ,    0 ,   -1 } ,
            {   1 ,    0 ,   -2 ,    2 ,   -2 } ,
            {   1 ,    2 ,    0 ,   -2 ,    0 } ,
            {   2 ,    0 ,    0 ,    2 ,   -2 } ,
            {   0 ,    0 ,    1 ,    0 ,    0 } ,
            {   2 ,    0 ,    1 ,    2 ,   -2 } ,
            {   2 ,    0 ,   -1 ,    2 ,   -2 } ,
            {   1 ,    0 ,    0 ,    2 ,   -2 } ,
            {   0 ,    2 ,    0 ,    0 ,   -2 } ,
            {   0 ,    0 ,    0 ,    2 ,   -2 } ,
            {   0 ,    0 ,    2 ,    0 ,    0 } ,
            {   1 ,    0 ,    1 ,    0 ,    0 } ,
            {   2 ,    0 ,    2 ,    2 ,   -2 } ,
            {   1 ,    0 ,   -1 ,    0 ,    0 } ,
            {   1 ,   -2 ,    0 ,    0 ,    2 } ,
            {   1 ,    0 ,   -1 ,    2 ,   -2 } ,
            {   1 ,    2 ,    0 ,    0 ,   -2 } ,
            {   1 ,    0 ,    1 ,    2 ,   -2 } ,
            {   0 ,    1 ,    0 ,    0 ,   -1 } ,
            {   0 ,    2 ,    1 ,    0 ,   -2 } ,
            {   1 ,    0 ,    0 ,   -2 ,    2 } ,
            {   0 ,    0 ,    1 ,   -2 ,    2 } ,
            {   2 ,    0 ,    1 ,    0 ,    0 } ,
            {   1 ,   -1 ,    0 ,    0 ,    1 } ,
            {   0 ,    0 ,    1 ,    2 ,   -2 } ,
            {   2 ,    0 ,    0 ,    2 ,    0 } ,
            {   0 ,    1 ,    0 ,    0 ,    0 } ,
            {   1 ,    0 ,    0 ,    2 ,    0 } ,
            {   2 ,    1 ,    0 ,    2 ,    0 } ,
            {   0 ,    1 ,    0 ,    0 ,   -2 } ,
            {   2 ,   -1 ,    0 ,    2 ,    0 } ,
            {   0 ,    0 ,    0 ,    0 ,    2 } ,
            {   1 ,    1 ,    0 ,    0 ,    0 } ,
            {   1 ,   -1 ,    0 ,    0 ,    0 } ,
            {   2 ,   -1 ,    0 ,    2 ,    2 } ,
            {   1 ,    1 ,    0 ,    2 ,    0 } ,
            {   2 ,    0 ,    0 ,    2 ,    2 } ,
            {   0 ,    2 ,    0 ,    0 ,    0 } ,
            {   2 ,    1 ,    0 ,    2 ,   -2 } ,
            {   2 ,    2 ,    0 ,    2 ,    0 } ,
            {   0 ,    0 ,    0 ,    2 ,    0 } ,
            {   1 ,   -1 ,    0 ,    2 ,    0 } ,
            {   1 ,   -1 ,    0 ,    0 ,    2 } ,
            {   1 ,    1 ,    0 ,    0 ,   -2 } ,
            {   1 ,   -1 ,    0 ,    2 ,    2 } ,
            {   0 ,    1 ,    1 ,    0 ,   -2 } ,
            {   2 ,    0 ,    1 ,    2 ,    0 } ,
            {   2 ,    0 ,   -1 ,    2 ,    0 } ,
            {   2 ,    1 ,    0 ,    2 ,    2 } ,
            {   0 ,    1 ,    0 ,    0 ,    2 } ,
            {   2 ,    2 ,    0 ,    2 ,   -2 } ,
            {   1 ,    0 ,    0 ,    0 ,    2 } ,
            {   1 ,    0 ,    0 ,    2 ,    2 } ,
            {   1 ,    1 ,    0 ,    2 ,   -2 } ,
            {   1 ,    0 ,    0 ,    0 ,   -2 } ,
            {   0 ,    1 ,   -1 ,    0 ,    0 } ,
            {   1 ,    2 ,    0 ,    2 ,    0 } ,
            {   0 ,    0 ,    1 ,    0 ,   -2 } ,
            {   0 ,    1 ,    0 ,   -2 ,    0 } ,
            {   0 ,    0 ,    0 ,    0 ,    1 } ,
            {   0 ,    1 ,    1 ,    0 ,    0 } ,
            {   0 ,    1 ,    0 ,    2 ,    0 } ,
            {   2 ,    1 ,   -1 ,    2 ,    0 } ,
            {   2 ,   -1 ,   -1 ,    2 ,    2 } ,
            {   1 ,   -2 ,    0 ,    0 ,    0 } ,
            {   2 ,    3 ,    0 ,    2 ,    0 } ,
            {   2 ,    0 ,   -1 ,    2 ,    2 } ,
            {   2 ,    1 ,    1 ,    2 ,    0 } ,
            {   1 ,   -1 ,    0 ,    2 ,   -2 } ,
            {   1 ,    2 ,    0 ,    0 ,    0 } ,
            {   2 ,    1 ,    0 ,    0 ,    0 } ,
            {   0 ,    3 ,    0 ,    0 ,    0 } ,
            {   2 ,    0 ,    0 ,    2 ,    1 } ,
            {   2 ,   -1 ,    0 ,    0 ,    0 } ,
            {   0 ,    1 ,    0 ,    0 ,   -4 } ,
            {   2 ,   -2 ,    0 ,    2 ,    2 } ,
            {   2 ,   -1 ,    0 ,    2 ,    4 } ,
            {   0 ,    2 ,    0 ,    0 ,   -4 } ,
            {   2 ,    1 ,    1 ,    2 ,   -2 } ,
            {   1 ,    1 ,    0 ,    2 ,    2 } ,
            {   2 ,   -2 ,    0 ,    2 ,    4 } ,
            {   2 ,   -1 ,    0 ,    4 ,    0 } ,
            {   0 ,    1 ,   -1 ,    0 ,   -2 } ,
            {   1 ,    2 ,    0 ,    2 ,   -2 } ,
            {   2 ,    2 ,    0 ,    2 ,    2 } ,
            {   1 ,    1 ,    0 ,    0 ,    2 } ,
            {   2 ,    0 ,    0 ,    4 ,   -2 } ,
            {   2 ,    3 ,    0 ,    2 ,   -2 } ,
            {   0 ,    1 ,    0 ,    2 ,   -2 } ,
            {   1 ,    0 ,    1 ,    2 ,    0 } ,
            {   1 ,   -1 ,   -1 ,    0 ,    2 } ,
            {   1 ,    0 ,    0 ,   -2 ,    0 } ,
            {   2 ,    0 ,    0 ,    2 ,   -1 } ,
            {   0 ,    0 ,    1 ,    0 ,    2 } ,
            {   0 ,    1 ,    0 ,   -2 ,   -2 } ,
            {   1 ,    0 ,   -1 ,    2 ,    0 } ,
            {   1 ,    1 ,    1 ,    0 ,   -2 } ,
            {   0 ,    1 ,    0 ,   -2 ,    2 } ,
            {   0 ,    2 ,    0 ,    0 ,    2 } ,
            {   2 ,    0 ,    0 ,    2 ,    4 } ,
            {   0 ,    0 ,    1 ,    0 ,    1 } } ;
    
    // 1980 IAU Theory of Nutation  ( J. M. Wahr )
    double nut_coeff[106][4] =
          { {   -17.199600 ,     -0.017420 ,      9.202500 ,      0.000890 } ,
            {     0.206200 ,      0.000020 ,     -0.089500 ,      0.000050 } ,
            {     0.004600 ,      0.000000 ,     -0.002400 ,      0.000000 } ,
            {     0.001100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000200 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -1.318700 ,     -0.000160 ,      0.573600 ,     -0.000310 } ,
            {     0.142600 ,     -0.000340 ,      0.005400 ,     -0.000010 } ,
            {    -0.051700 ,      0.000120 ,      0.022400 ,     -0.000060 } ,
            {     0.021700 ,     -0.000050 ,     -0.009500 ,      0.000030 } ,
            {     0.012900 ,      0.000010 ,     -0.007000 ,      0.000000 } ,
            {     0.004800 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.002200 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.001700 ,     -0.000010 ,      0.000000 ,      0.000000 } ,
            {    -0.001500 ,      0.000000 ,      0.000900 ,      0.000000 } ,
            {    -0.001600 ,      0.000010 ,      0.000700 ,      0.000000 } ,
            {    -0.001200 ,      0.000000 ,      0.000600 ,      0.000000 } ,
            {    -0.000600 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {    -0.000500 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {     0.000400 ,      0.000000 ,     -0.000200 ,      0.000000 } ,
            {     0.000400 ,      0.000000 ,     -0.000200 ,      0.000000 } ,
            {    -0.000400 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.227400 ,     -0.000020 ,      0.097700 ,     -0.000050 } ,
            {     0.071200 ,      0.000010 ,     -0.000700 ,      0.000000 } ,
            {    -0.038600 ,     -0.000040 ,      0.020000 ,      0.000000 } ,
            {    -0.030100 ,      0.000000 ,      0.012900 ,     -0.000010 } ,
            {    -0.015800 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {     0.012300 ,      0.000000 ,     -0.005300 ,      0.000000 } ,
            {     0.006300 ,      0.000000 ,     -0.000200 ,      0.000000 } ,
            {     0.006300 ,      0.000010 ,     -0.003300 ,      0.000000 } ,
            {    -0.005800 ,     -0.000010 ,      0.003200 ,      0.000000 } ,
            {    -0.005900 ,      0.000000 ,      0.002600 ,      0.000000 } ,
            {    -0.005100 ,      0.000000 ,      0.002700 ,      0.000000 } ,
            {    -0.003800 ,      0.000000 ,      0.001600 ,      0.000000 } ,
            {     0.002900 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {     0.002900 ,      0.000000 ,     -0.001200 ,      0.000000 } ,
            {    -0.003100 ,      0.000000 ,      0.001300 ,      0.000000 } ,
            {     0.002600 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {     0.002100 ,      0.000000 ,     -0.001000 ,      0.000000 } ,
            {     0.001600 ,      0.000000 ,     -0.000800 ,      0.000000 } ,
            {    -0.001300 ,      0.000000 ,      0.000700 ,      0.000000 } ,
            {    -0.001000 ,      0.000000 ,      0.000500 ,      0.000000 } ,
            {    -0.000700 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000700 ,      0.000000 ,     -0.000300 ,      0.000000 } ,
            {    -0.000700 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {    -0.000800 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {     0.000600 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000600 ,      0.000000 ,     -0.000300 ,      0.000000 } ,
            {    -0.000600 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {    -0.000700 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {     0.000600 ,      0.000000 ,     -0.000300 ,      0.000000 } ,
            {    -0.000500 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {     0.000500 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000500 ,      0.000000 ,      0.000300 ,      0.000000 } ,
            {    -0.000400 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000400 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000400 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000300 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000200 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000300 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {     0.000200 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000200 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {     0.000200 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000200 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {     0.000200 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000200 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000200 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000100 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,     -0.000100 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {    -0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } ,
            {     0.000100 ,      0.000000 ,      0.000000 ,      0.000000 } } ;

    double ts = (tdb - 51544) / 36525;
    double delta_psi = 0, delta_eps = 0;
    int i, j;

    double fund_args[5];
    get_fundumental_args(tdb, fund_args);

    double r = 0;
    for (i=0; i<106; i++)
    {
        r = nut_args[i][0] * (fund_args[0] - fund_args[3]);
        for (j=1; j<5; j++)
        {
            r += nut_args[i][j] * fund_args[j];
        }
        delta_psi += (nut_coeff[i][0] + ts*nut_coeff[i][1]) * sin(r);
        delta_eps += (nut_coeff[i][2] + ts*nut_coeff[i][3]) * cos(r);
    }
    *psi = delta_psi * SEC_IN_RAD;
    *eps = delta_eps * SEC_IN_RAD;

    return;
}


void get_nutation_matrix(double tdb, double nutation_matrix[3][3])
{
    double eps = get_eps_mean(tdb);

    double delta_psi, delta_eps;
    get_nutation_parameters(tdb, &delta_psi, &delta_eps);

    double Rx_deps[3][3], Rz_psi[3][3], Rx_eps[3][3], R[3][3];
    rotate_by_x(-eps-delta_eps, Rx_deps);
    rotate_by_z(-delta_psi, Rz_psi);
    rotate_by_x(eps, Rx_eps);
    mult_matrix(Rz_psi, Rx_eps, R);
    mult_matrix(Rx_deps, R, nutation_matrix);

    return;
}